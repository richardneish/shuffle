<!doctype html>
<html lang="en" manifest="offline.manifest">
<head>
    <meta charset="utf-8" />
    <title>Shuffle letters</title>
    <link rel="stylesheet" href="lib/1/jquery-ui.css" />
    <script src="lib/1/jquery-1.10.2.min.js"></script>
    <script src="lib/1/jquery-ui.js"></script>
    <script src="lib/1/jquery.ui.touch-punch.min.js"></script>
    <style>
        #shuffle { list-style-type: none; margin: 0; padding: 0; width: 450px; text-transform: capitalize; }
        #shuffle li { margin: 3px 3px 3px 0; padding: 1px; float: left; width: 20px; height: 20px; text-align: center; }
        #circleLayout { position: relative; top: 100px; text-transform: capitalize; }
        .rotatedLetterHolder { position: absolute; width: 20px; top: 20px; transform-origin: bottom center; text-transform: capitalize; }
    </style>
    <script>
        function doCircleLayout() {
          var input = document.querySelector("#input");
          var output = document.querySelector("#circleLayout");
          var s = input.value;
          // Remove all current letters from the shuffle.
          while (output.firstChild) {
            output.removeChild(output.firstChild);
          }
          // Add the letters of the current string.
          var length = s.length;
          var size = length * 15;
          for (var i = 0; i < length; i++) {
            var elementRotation = i * 360 / (length);
            var holder = document.createElement("span");
            var letter = document.createElement("p");
            holder.setAttribute("class", "rotatedLetterHolder");
            if (elementRotation != 0) {
              holder.setAttribute("style", "transform: rotate(" + elementRotation + "deg);");
              letter.setAttribute("style", "transform: rotate(-" + elementRotation + "deg);");
            }
            holder.style.height = size + "px";
            holder.style.left = size + "px";
            letter.appendChild(document.createTextNode(s[i]));
            holder.appendChild(letter);
            output.appendChild(holder);
          }
        }

        function knuth_shuffle(a) {
            var arr = new Array(a.length)
            for (var i = 0; i < a.length; i++) {
                arr[i] = a[i]
            }
            var n = arr.length,
                    r,
                    temp;
            while (n > 1) {
                r = Math.floor(n * Math.random());
                n -= 1;
                temp = arr[n];
                arr[n] = arr[r];
                arr[r] = temp;
            }
            return arr.join('');
        }

        function update() {
            var input = document.querySelector("#input");
            var shuffle = document.querySelector("#shuffle");
            // Update the shuffle tiles.
            var s = input.value;
            // Remove all current letters from the shuffle.
            while (shuffle.firstChild) {
              shuffle.removeChild(shuffle.firstChild);
            }

            // Add the letters of the current string.
            for (var i = 0; i < s.length; i++) {
              $('<li class="ui-state-default drag">' + s[i] + 
                ' <input type="checkbox" class="shuffle-lock"></li>').appendTo(shuffle);
            }
            $('.shuffle-lock').onclick = function(event) {
              $(event.target).parents("li").toggleClass('locked');
            }

            $('#sortable').sortable({
              axis: 'x',
              containment: 'parent',
              items: ':not(.locked)',
              start: function(){
                $('.locked', this).each(function(){
                  var $this = $(this);
                  $this.data('pos', $this.index());
                });
              },
              change: function(){
                $sortable = $(this);
                $statics = $('.locked', this).detach();
                $helper = $('<li></li>').prependTo(this);
                $statics.each(function(){
                  var $this = $(this);
                  var target = $this.data('pos');

                  $this.insertAfter($('li', $sortable).eq(target));
                });
                $helper.remove();
              }
              $('#sortable').sortable({
                items: ':not(.static)',
                start: function(){
                  $('.static', this).each(function(){
                    var $this = $(this);
                    $this.data('pos', $this.index());
                  });
                },
                change: function(){
                  $sortable = $(this);
                  $statics = $('.static', this).detach();
                  $helper = $('<li></li>').prependTo(this);
                  $statics.each(function(){
                    var $this = $(this);
                    var target = $this.data('pos');

                    $this.insertAfter($('li', $sortable).eq(target));
                  });
                  $helper.remove();
                }
              });
            });

            doCircleLayout();
        }

        function doShuffle(event) {
          var input = document.querySelector("#input");
          input.value = knuth_shuffle(input.value);
          input.onkeyup({target: input});
        }
    </script>
</head>
<body>
<input id="input" type="text" value="" onkeyup="update(); return false"/>
<button id="doShuffle" onclick="doShuffle(); return false;">Shuffle</button>
<div><ul id="shuffle"></ul></div>
<div id="circleLayout"/>
</body>
</html>
